<%- include("partials/aside") %>

<main class="flex-1 p-6 overflow-auto">
  <div class="flex justify-between items-end">
    <div>
      <h1 class="text-3xl font-bold text-[#000]">Manage Blogs</h1>
      <p class="mt-2 text-gray-700">Create, edit, or delete your blogs below.</p>
    </div>

    <!-- Add Blog Button -->
    <div>
      <button
        id="openAddModalBtn"



        +-*+
        class="font-medium text-[#000] border border-[#000] px-6 py-2 text-[14px] cursor-pointer rounded hover:bg-[#000] hover:text-white transition"
      >
        + Add Blog
      </button>
    </div>
  </div>

  <!-- Blog Table -->
  <div class="bg-white p-6 rounded shadow mt-6 overflow-x-auto">
    <h2 class="text-[#000] font-semibold text-xl mb-4">Blogs List</h2>
    <table class="min-w-full table-auto border-collapse">
      <thead>
        <tr class="bg-gray-100 text-left">
          <th class="px-4 py-2 border">Title</th>
          <th class="px-4 py-2 border">Author</th>
          <th class="px-4 py-2 border">Content</th>
          <th class="px-4 py-2 border">Image</th>
          <th class="px-4 py-2 border">Actions</th>
        </tr>
      </thead>
      <tbody id="blogTableBody">
        <% data?.blog.forEach(blog => { %>
          <tr>
            <td class="px-4 py-2 border"><%= blog.title %></td>
            <td class="px-4 py-2 border"><%= blog.author_name %></td>
            <td class="px-4 py-2 border truncate-text"><%= blog.description %></td>
            <td class="px-4 py-2 border">
              <img src="/<%= blog.image %>" class="h-16 w-16 object-cover rounded" alt="<%= blog.title %>" />
            </td>
            <td class="px-4 py-2 border space-x-2">
              <button
                class="bg-[#000] text-white px-2 py-1 rounded cursor-pointer openEditModalBtn"
                data-id="<%= blog._id %>"
                data-title="<%= blog.title %>"
                data-author="<%= blog.author_name %>"
                data-description="<%= blog.description %>"
                data-image="<%= blog.image %>"
              >
                Edit
              </button>
              <button class="border cursor-pointer px-2 py-1 rounded deleteBtn" data-id="<%= blog._id %>">
                Delete
              </button>
            </td>
          </tr>
        <% }) %>
      </tbody>
      
    </table>
  </div>
</main>

<!-- Add Blog Modal -->
<div id="addBlogModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
  <div class="bg-white w-[90%] max-w-lg rounded-lg shadow-lg p-6 relative max-h-[90vh] overflow-y-auto">
    <button id="closeAddModalBtn" class="absolute top-3 right-3 text-gray-500 hover:text-black text-xl">
      &times;
    </button>
    <h2 class="text-[#000] font-semibold text-xl mb-4">Add New Blog</h2>
    <form id="addBlogForm" class="space-y-4">

      <!-- Title -->
      <div>
        <label class="block text-gray-700 font-medium mb-1" for="blogTitle">Title</label>
        <input type="text" id="blogTitle" name="title" class="w-full border border-gray-300 rounded p-2" required />
      </div>

      <!-- SubTitle -->
      <div>
        <label class="block text-gray-700 font-medium mb-1" for="subTitle">Sub Title</label>
        <input type="text" id="subTitle" name="subTitle" class="w-full border border-gray-300 rounded p-2" />
      </div>

      <!-- Author Name -->
      <div>
        <label class="block text-gray-700 font-medium mb-1" for="author_name">Author Name</label>
        <input type="text" id="author_name" name="author_name" class="w-full border border-gray-300 rounded p-2" />
      </div>

      <!-- Date -->
      <div>
        <label class="block text-gray-700 font-medium mb-1" for="date">Date</label>
        <input type="date" id="date" name="date" class="w-full border border-gray-300 rounded p-2" />
      </div>

      <!-- Category -->
      <div>
        <label class="block text-gray-700 font-medium mb-1" for="category">Category</label>
        <select id="category" name="category" class="w-full border border-gray-300 rounded p-2">
          <option value="Education">Education</option>
          <option value="Content-Writing">Content-Writing</option>
          <option value="Blog-Article">Blog-Article</option>
        </select>
      </div>

      <!-- Links -->
      <div>
        <label class="block text-gray-700 font-medium mb-1" for="links">Links</label>
        <input type="text" id="links" name="links" placeholder="Comma separated links" class="w-full border border-gray-300 rounded p-2" />
      </div>

      <!-- Popular -->
      <div>
        <label class="block text-gray-700 font-medium mb-1" for="ispopular">Is Popular</label>
        <select  id="ispopular" name="ispopular"  class="w-full border border-gray-300 rounded p-2">
          <option value="">Select</option>
          <option value="true">Yes</option>
          <option value="false">No</option>
        </select>
      </div>

      <!-- Description / Content -->
      <div>
        <label class="block text-gray-700 font-medium mb-1" for="description">Description</label>
        <textarea id="description" name="description" rows="4" class="w-full border border-gray-300 rounded p-2"></textarea>
      </div>

      <!-- Image -->
      <div>
        <label class="block text-gray-700 font-medium mb-1" for="image">Image</label>
        <input type="file" id="image" name="image" class="w-full cursor-pointer border border-gray-300 rounded p-2" required />
      </div>

      <!-- SEO Meta Info -->
      <div class="border-t pt-4 mt-4">
        <h3 class="text-lg font-semibold text-[#000] mb-2">SEO Meta Info</h3>
        <input type="text" id="meta_title" name="meta_title" placeholder="Meta Title" class="w-full border border-gray-300 rounded p-2 mb-2" />
        <textarea id="meta_description" name="meta_description" placeholder="Meta Description" rows="2" class="w-full border border-gray-300 rounded p-2 mb-2"></textarea>
        <input type="text" id="keywords" name="keywords" placeholder="Keywords" class="w-full border border-gray-300 rounded p-2" />
      </div>

      <!-- OG Info -->
      <div class="border-t pt-4 mt-4">
        <h3 class="text-lg font-semibold text-[#000] mb-2">Open Graph (OG) Info</h3>
        <input type="text" id="og_title" name="og_title" placeholder="OG Title" class="w-full border border-gray-300 rounded p-2 mb-2" />
        <textarea id="og_description" name="og_description" placeholder="OG Description" rows="2" class="w-full border border-gray-300 rounded p-2 mb-2"></textarea>
        <input type="file" id="og_image" name="og_image" class="w-full border border-gray-300 rounded p-2 cursor-pointer mb-2" />
        <input type="text" id="og_url" name="og_url" placeholder="OG URL" class="w-full border border-gray-300 rounded p-2 mb-2" />
        <input type="text" id="og_type" name="og_type" placeholder="OG Type" class="w-full border border-gray-300 rounded p-2" />
      </div>

      <button type="submit" class="bg-[#000] text-white px-4 py-2 rounded hover:bg-gray-800 transition mt-4">
        Add Blog
      </button>
    </form>
  </div>
</div>
<!-- Edit Blog Modal -->
<div
  id="editBlogModal"
  class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50"
>
  <div class="bg-white w-[90%] max-w-lg rounded-lg shadow-lg p-6 relative max-h-[90vh] overflow-y-auto">
    <button
      id="closeEditModalBtn"
      class="absolute top-3 right-3 text-gray-500 hover:text-black text-xl"
    >
      &times;
    </button>
    <h2 class="text-[#000] font-semibold text-xl mb-4">Edit Blog</h2>
    <form id="editBlogForm" class="space-y-4">

      <!-- Title -->
      <div>
        <label class="block text-gray-700 font-medium mb-1" for="editTitle">Title</label>
        <input type="text" id="editTitle" name="title" class="w-full border border-gray-300 rounded p-2" required />
      </div>

      <!-- SubTitle -->
      <div>
        <label class="block text-gray-700 font-medium mb-1" for="editSubTitle">Sub Title</label>
        <input type="text" id="editSubTitle" name="subTitle" class="w-full border border-gray-300 rounded p-2" />
      </div>

      <!-- Author Name -->
      <div>
        <label class="block text-gray-700 font-medium mb-1" for="editAuthor">Author Name</label>
        <input type="text" id="editAuthor" name="author_name" class="w-full border border-gray-300 rounded p-2" />
      </div>

      <!-- Date -->
      <div>
        <label class="block text-gray-700 font-medium mb-1" for="editDate">Date</label>
        <input type="date" id="editDate" name="date" class="w-full border border-gray-300 rounded p-2" />
      </div>

      <!-- Category -->
      <div>
        <label class="block text-gray-700 font-medium mb-1" for="editCategory">Category</label>
        <select id="editCategory" name="category" class="w-full border border-gray-300 rounded p-2">
          <option value="Education">Education</option>
          <option value="Content-Writing">Content-Writing</option>
          <option value="Blog-Article">Blog-Article</option>
        </select>
      </div>

      <!-- Links -->
      <div>
        <label class="block text-gray-700 font-medium mb-1" for="editLinks">Links</label>
        <input type="text" id="editLinks" name="links" placeholder="Comma separated links" class="w-full border border-gray-300 rounded p-2" />
      </div>

      <!-- Is Popular -->
      <div>
        <label class="block text-gray-700 font-medium mb-1" for="editIsPopular">Is Popular</label>
        <select id="editIsPopular" name="ispopular" class="w-full border border-gray-300 rounded p-2">
          <option value="">Select</option>
          <option value="true">Yes</option>
          <option value="false">No</option>
        </select>
      </div>

      <!-- Description -->
      <div>
        <label class="block text-gray-700 font-medium mb-1" for="editDescription">Description</label>
        <textarea id="editDescription" name="description" rows="4" class="w-full border border-gray-300 rounded p-2"></textarea>
      </div>

      <!-- Image -->
      <div>
        <label class="block text-gray-700 font-medium mb-1" for="editImage">Image</label>
        <input type="file" id="editImage" name="image" class="w-full cursor-pointer border border-gray-300 rounded p-2" />
      </div>

      <!-- SEO Meta Info -->
      <div class="border-t pt-4 mt-4">
        <h3 class="text-lg font-semibold text-[#000] mb-2">SEO Meta Info</h3>
        <input type="text" id="editMetaTitle" name="meta_title" placeholder="Meta Title" class="w-full border border-gray-300 rounded p-2 mb-2" />
        <textarea id="editMetaDescription" name="meta_description" placeholder="Meta Description" rows="2" class="w-full border border-gray-300 rounded p-2 mb-2"></textarea>
        <input type="text" id="editKeywords" name="keywords" placeholder="Keywords" class="w-full border border-gray-300 rounded p-2" />
      </div>

      <!-- OG Info -->
      <div class="border-t pt-4 mt-4">
        <h3 class="text-lg font-semibold text-[#000] mb-2">Open Graph (OG) Info</h3>
        <input type="text" id="editOgTitle" name="og_title" placeholder="OG Title" class="w-full border border-gray-300 rounded p-2 mb-2" />
        <textarea id="editOgDescription" name="og_description" placeholder="OG Description" rows="2" class="w-full border border-gray-300 rounded p-2 mb-2"></textarea>
        <input type="file" id="editOgImage" name="og_image" class="w-full border border-gray-300 rounded p-2 cursor-pointer mb-2" />
        <input type="text" id="editOgUrl" name="og_url" placeholder="OG URL" class="w-full border border-gray-300 rounded p-2 mb-2" />
        <input type="text" id="editOgType" name="og_type" placeholder="OG Type" class="w-full border border-gray-300 rounded p-2" />
      </div>

 

      <button type="submit" class="bg-[#000] text-white px-4 py-2 rounded hover:bg-gray-800 transition mt-4">
        Save Changes
      </button>
    </form>
  </div>
</div>


<script>
  const editBlogModal = document.getElementById("editBlogModal");
  const closeEditModalBtn = document.getElementById("closeEditModalBtn");
  const editBlogForm = document.getElementById("editBlogForm");
  let currentEditId = null;

  // Edit button functionality
  document.querySelectorAll(".openEditModalBtn").forEach((btn) => {
    btn.addEventListener("click", async (e) => {
      const blogId = btn.getAttribute("data-id");
      currentEditId = blogId;

      try {
        const res = await fetch(`/api/blog/${blogId}`);
        const blog = await res.json();
       console.log("blog---?",blog);
       
        // Fill data in form fields
        document.getElementById("editTitle").value = blog?.data?.title || "";
        document.getElementById("editSubTitle").value = blog?.data?.subTitle || "";
        document.getElementById("editAuthor").value = blog?.data?.author_name || "";
        document.getElementById("editDate").value = blog?.data?.date || "";
        document.getElementById("editCategory").value = blog?.data?.category || "Education";
        document.getElementById("editLinks").value = blog?.data?.links || "";
        document.getElementById("editIsPopular").value = blog?.data?.ispopular || "";
        document.getElementById("editDescription").value = blog?.data?.description || "";
        document.getElementById("editMetaTitle").value = blog?.data?.meta_title || "";
        document.getElementById("editMetaDescription").value = blog?.data?.meta_description || "";
        document.getElementById("editKeywords").value = blog?.data?.keywords || "";
        document.getElementById("editOgTitle").value = blog?.data?.og_title || "";
        document.getElementById("editOgDescription").value = blog?.data?.og_description || "";
        document.getElementById("editOgUrl").value = blog?.data?.og_url || "";
        document.getElementById("editOgType").value = blog?.data?.og_type || "";

        // Show modal
        editBlogModal.classList.remove("hidden");
      } catch (error) {
        console.error("Error fetching blog:", error);
      }
    });
  });

  // Close modal
  closeEditModalBtn.addEventListener("click", () => {
    editBlogModal.classList.add("hidden");
  });

  // Handle form submit
  editBlogForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!currentEditId) return alert("Blog ID missing!");

    const formData = new FormData(editBlogForm);

    try {
      const res = await fetch(`/api/blog/${currentEditId}`, {
        method: "PUT",
        body: formData,
      });

      const data = await res.json();

      if (data.status) {
        alert("Blog updated successfully!");
        editBlogModal.classList.add("hidden");
        location.reload(); // refresh table
      } else {
        alert("Failed to update blog: " + data.message);
      }
    } catch (error) {
      console.error("Error updating blog:", error);
      alert("Something went wrong!");
    }
  });
</script>


<!-- blog add ki api  -->
<script>
  // Modal Open/Close
  const openAddModalBtn = document.getElementById("openAddModalBtn"); // Jo button se modal open hoga
  const addBlogModal = document.getElementById("addBlogModal");
  const closeAddModalBtn = document.getElementById("closeAddModalBtn");

  openAddModalBtn.addEventListener("click", () => {
    addBlogModal.classList.remove("hidden");
  });

  closeAddModalBtn.addEventListener("click", () => {
    addBlogModal.classList.add("hidden");
  });

  // Form Submit
  const addBlogForm = document.getElementById("addBlogForm");

  addBlogForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData();

    // Add all input fields to FormData
    formData.append("title", document.getElementById("blogTitle").value);
    formData.append("subTitle", document.getElementById("subTitle").value);
    formData.append("author_name", document.getElementById("author_name").value);
    formData.append("date", document.getElementById("date").value);
    formData.append("category", document.getElementById("category").value);
    formData.append("links", document.getElementById("links").value);
    formData.append("ispopular", document.getElementById("ispopular").value);
    formData.append("description", document.getElementById("description").value);

    const imageFile = document.getElementById("image").files[0];
    if (imageFile) formData.append("image", imageFile);

    formData.append("meta_title", document.getElementById("meta_title").value);
    formData.append("meta_description", document.getElementById("meta_description").value);
    formData.append("keywords", document.getElementById("keywords").value);

    const ogImageFile = document.getElementById("og_image").files[0];
    if (ogImageFile) formData.append("og_image", ogImageFile);

    formData.append("og_title", document.getElementById("og_title").value);
    formData.append("og_description", document.getElementById("og_description").value);
    formData.append("og_url", document.getElementById("og_url").value);
    formData.append("og_type", document.getElementById("og_type").value);

    try {
      const res = await fetch("/api/blog", {  
        method: "POST",
        body: formData
      });

      const data = await res.json();

      if (data.status) {
        alert("Blog added successfully!");
        addBlogForm.reset();
        addBlogModal.classList.add("hidden");
      location.reload()
      } else {
        alert("Error: " + data.message);
      }
    } catch (err) {
      console.error(err);
      alert("Something went wrong!");
    }
  });
</script>

<!-- delete ki api -->
<script>
  // Select all delete buttons
  const deleteButtons = document.querySelectorAll(".deleteBtn");

  deleteButtons.forEach(btn => {
    btn.addEventListener("click", async () => {
      const blogId = btn.dataset.id;

      if (!confirm("Are you sure you want to delete this blog?")) return;

      try {
        const res = await fetch(`/api/blog/${blogId}`, {
          method: "DELETE",
        });

        const data = await res.json();

        if (data.status) {
          alert("Blog deleted successfully!");
          // Remove the table row
          btn.closest("tr").remove();
        } else {
          alert("Error: " + data.message);
        }
      } catch (err) {
        console.error(err);
        alert("Something went wrong!");
      }
    });
  });
</script>
