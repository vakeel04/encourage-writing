<%- include("partials/aside") %>

<main class="flex-1 p-6 overflow-auto">
  <!-- Header -->
  <div class="flex justify-between items-end">
    <div>
      <h1 class="text-3xl font-bold text-[#000]">Manage Ideas</h1>
      <p class="mt-2 text-gray-700">
        Create, edit, or delete your Ideas below.
      </p>
    </div>

    <!-- Add Button -->
    <div>
      <button
        id="openAddModalBtn"
        class="font-medium text-[#000] border border-[#000] px-6 py-2 text-[14px] cursor-pointer rounded hover:bg-[#000] hover:text-white transition"
      >
        + Add Service
      </button>
    </div>
  </div>

  <!-- Ideas Table -->
  <div class="bg-white p-6 rounded shadow mt-6 overflow-x-auto">
    <h2 class="text-[#000] font-semibold text-xl mb-4">Ideas List</h2>
    <table class="min-w-full table-auto border-collapse">
      <thead>
        <tr class="bg-gray-100 text-left">
          <th class="px-4 py-2 border">Title</th>
          <th class="px-4 py-2 border">Sub Title</th>
          <th class="px-4 py-2 border">Detail Title</th>
          <th class="px-4 py-2 border">Detail Description</th>
          <th class="px-4 py-2 border">Detail Image</th>
          <th class="px-4 py-2 border">Detail Date</th>
          <th class="px-4 py-2 border">Actions</th>
        </tr>
      </thead>

      <tbody id="ideasTableBody">
        <% if (data && data.ideas) { %>
          <% data.ideas.forEach((idea, i) => { %>
            <% if (idea.detail && idea.detail.length) { %>
              <% idea.detail.forEach((d, j) => { %>
                <tr>
                  <% if (j === 0) { %>
                    <td class="px-4 py-2 border" rowspan="<%= idea.detail.length %>"><%= idea.title %></td>
                    <td class="px-4 py-2 border" rowspan="<%= idea.detail.length %>"><%= idea.subTitle %></td>
                  <% } %>
      
                  <td class="px-4 py-2 border"><%= d.title %></td>
                  <td class="px-4 py-2 border"><%= d.description %></td>
      
                  <td class="px-4 py-2 border">
                    <% if (d.image) { %>
                      <img src="/<%= d.image %>" alt="<%= d.title %>" class="h-16 w-16 object-cover rounded" />
                    <% } %>
                  </td>
      
                  <td class="px-4 py-2 border">
                    <%= d.date ? new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '' %>
                  </td>
      
                  <% if (j === 0) { %>
                    <td class="px-4 py-2 border space-x-2" rowspan="<%= idea.detail.length %>">
                      <button
                        class="bg-[#000] text-white px-2 py-1 rounded cursor-pointer openEditModalBtn"
                        data-id="<%= idea._id %>"
                        data-title='<%- JSON.stringify(idea.detail[0]?.title || "") %>'
                        data-description='<%- JSON.stringify(idea.detail[0]?.description || "") %>'
                        data-image='<%- JSON.stringify(idea.detail[0]?.image || "") %>'
                      >
                        Edit
                      </button>
      
                      <button
                        class="border cursor-pointer px-2 py-1 rounded deleteBtn"
                        data-id="<%= idea._id %>"
                      >
                        Delete
                      </button>
                    </td>
                  <% } %>
                </tr>
              <% }) %>
            <% } %>
          <% }) %>
        <% } %>
      </tbody>
      
    </table>
  </div>
</main>

<!-- Add Idea Modal -->
<div
  id="addIdeaModal"
  class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50 overflow-auto"
>
  <div
    class="bg-white w-[90%] h-[730px] overflow-y-scroll max-w-2xl rounded-lg shadow-lg p-6 relative"
  >
    <!-- Close Button -->
    <button
      id="closeAddModalBtn"
      class="absolute top-3 right-3 text-gray-500 hover:text-black text-xl"
    >
      &times;
    </button>

    <h2 class="text-[#000] font-semibold text-xl mb-4">Add New Idea</h2>

    <form id="addIdeaForm" class="space-y-4">
      <!-- Title -->
      <div>
        <label class="block text-gray-700 font-medium mb-1" for="title"
          >Title</label
        >
        <input
          type="text"
          id="title"
          name="title"
          class="w-full border border-gray-300 rounded p-2"
          required
        />
      </div>

      <!-- Sub Title -->
      <div>
        <label class="block text-gray-700 font-medium mb-1" for="subTitle"
          >Sub Title</label
        >
        <input
          type="text"
          id="subTitle"
          name="subTitle"
          class="w-full border border-gray-300 rounded p-2"
        />
      </div>

      <!-- Detail Sections -->
      <div id="detailsContainer" class="space-y-4">
        <div class="detail-section border border-gray-300 rounded p-4">
          <h3 class="text-[#000] font-semibold mb-2">Detail Section 1</h3>

          <div>
            <label class="block text-gray-700 font-medium mb-1"
              >Detail Title</label
            >
            <input
              type="text"
              name="detailTitle[]"
              class="w-full border border-gray-300 rounded p-2"
              required
            />
          </div>

          <div>
            <label class="block text-gray-700 font-medium mb-1"
              >Detail Description</label
            >
            <textarea
              name="detailDescription[]"
              class="w-full border border-gray-300 rounded p-2"
              rows="3"
            ></textarea>
          </div>

          <div>
            <label class="block text-gray-700 font-medium mb-1"
              >Detail Image</label
            >
            <input
              type="file"
              name="detailImage[]"
              class="w-full border border-gray-300 rounded p-2 cursor-pointer"
            />
          </div>

          <div>
            <label class="block text-gray-700 font-medium mb-1"
              >Detail Date</label
            >
            <input
              type="date"
              name="detailDate[]"
              class="w-full border border-gray-300 rounded p-2"
            />
          </div>
        </div>
      </div>

      <!-- Add More Detail Section Button -->
      <button
        type="button"
        id="addDetailSectionBtn"
        class="mt-2 bg-gray-200 text-[#000] px-3 py-1 rounded hover:bg-gray-300 transition"
      >
        + Add Detail Section
      </button>

      <!-- Meta Information -->
      <div class="border border-gray-300 rounded p-4">
        <h3 class="text-[#000] font-semibold mb-2">Meta Information</h3>

        <div>
          <label class="block text-gray-700 font-medium mb-1" for="meta_title"
            >Meta Title</label
          >
          <input
            type="text"
            id="meta_title"
            name="meta_title"
            class="w-full border border-gray-300 rounded p-2"
          />
        </div>

        <div>
          <label
            class="block text-gray-700 font-medium mb-1"
            for="meta_description"
            >Meta Description</label
          >
          <textarea
            id="meta_description"
            name="meta_description"
            class="w-full border border-gray-300 rounded p-2"
            rows="2"
          ></textarea>
        </div>

        <div>
          <label class="block text-gray-700 font-medium mb-1" for="keywords"
            >Keywords</label
          >
          <input
            type="text"
            id="keywords"
            name="keywords"
            class="w-full border border-gray-300 rounded p-2"
            placeholder="e.g. idea, creativity, innovation"
          />
        </div>
      </div>

      <!-- OG Section -->
      <div class="border border-gray-300 rounded p-4">
        <h3 class="text-[#000] font-semibold mb-2">OG (Open Graph) Data</h3>

        <div>
          <label class="block text-gray-700 font-medium mb-1" for="og_title"
            >OG Title</label
          >
          <input
            type="text"
            id="og_title"
            name="og_title"
            class="w-full border border-gray-300 rounded p-2"
          />
        </div>

        <div>
          <label
            class="block text-gray-700 font-medium mb-1"
            for="og_description"
            >OG Description</label
          >
          <textarea
            id="og_description"
            name="og_description"
            class="w-full border border-gray-300 rounded p-2"
            rows="2"
          ></textarea>
        </div>

        <div>
          <label class="block text-gray-700 font-medium mb-1" for="og_image"
            >OG Image</label
          >
          <input
            type="file"
            id="og_image"
            name="og_image"
            class="w-full border border-gray-300 rounded p-2 cursor-pointer"
          />
        </div>

        <div>
          <label class="block text-gray-700 font-medium mb-1" for="og_url"
            >OG URL</label
          >
          <input
            type="text"
            id="og_url"
            name="og_url"
            class="w-full border border-gray-300 rounded p-2"
          />
        </div>

        <div>
          <label class="block text-gray-700 font-medium mb-1" for="og_type"
            >OG Type</label
          >
          <input
            type="text"
            id="og_type"
            name="og_type"
            class="w-full border border-gray-300 rounded p-2"
            placeholder="e.g. article, website"
          />
        </div>
      </div>

      <!-- Submit Button -->
      <button
        type="submit"
        class="bg-[#000] text-white px-4 py-2 rounded hover:bg-gray-800 transition"
      >
        Add Idea
      </button>
    </form>
  </div>
</div>

<!-- Edit Idea Modal -->
<div
  id="editIdeaModal"
  class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50"
>
  <div
    class="bg-white w-[90%] max-w-3xl rounded-lg shadow-lg p-6 relative h-[90vh] overflow-y-auto"
  >
    <button
      id="closeEditModalBtn"
      class="absolute top-3 right-3 text-gray-500 hover:text-black text-xl"
    >
      &times;
    </button>

    <h2 class="text-[#000] font-semibold text-xl mb-4">Edit Idea</h2>
    <form id="editIdeaForm" class="space-y-4">
      <!-- Basic Info -->
      <div>
        <label class="block text-gray-700 mb-1">Title</label>
        <input
          type="text"
          id="editTitle"
          class="w-full border border-gray-300 rounded p-2"
          required
        />
      </div>

      <div>
        <label class="block text-gray-700 mb-1">Sub Title</label>
        <input
          type="text"
          id="editSubTitle"
          class="w-full border border-gray-300 rounded p-2"
        />
      </div>

      <!-- Detail Section -->
      <div id="editDetailContainer">
        <h3 class="text-lg font-semibold text-[#000] mb-2">Idea Details</h3>
        <div class="detail-item border p-3 rounded mb-3">
          <label class="block text-gray-700 mb-1">Detail Title</label>
          <input
            type="text"
            name="detail_title[]"
            class="w-full border border-gray-300 rounded p-2"
            required
          />

          <label class="block text-gray-700 mb-1 mt-2">Description</label>
          <textarea
            name="detail_description[]"
            rows="2"
            class="w-full border border-gray-300 rounded p-2"
          ></textarea>

          <label class="block text-gray-700 mb-1 mt-2">Image</label>
          <input
            type="file"
            name="detail_image[]"
            class="w-full border border-gray-300 rounded p-2 cursor-pointer"
          />

          <label class="block text-gray-700 mb-1 mt-2">Date</label>
          <input
            type="date"
            name="detail_date[]"
            class="w-full border border-gray-300 rounded p-2"
          />
        </div>
      </div>

      <button
        type="button"
        id="addMoreDetailBtn"
        class="border border-gray-400 text-gray-700 px-3 py-1 rounded hover:bg-gray-100"
      >
        + Add Another Detail
      </button>

      <!-- SEO Meta -->
      <div class="border-t pt-4 mt-4">
        <h3 class="text-lg font-semibold text-[#000] mb-2">SEO Meta Info</h3>

        <label class="block text-gray-700 mb-1">Meta Title</label>
        <input
          type="text"
          id="editMetaTitle"
          class="w-full border border-gray-300 rounded p-2"
        />

        <label class="block text-gray-700 mb-1 mt-2">Meta Description</label>
        <textarea
          id="editMetaDescription"
          rows="2"
          class="w-full border border-gray-300 rounded p-2"
        ></textarea>

        <label class="block text-gray-700 mb-1 mt-2">Keywords</label>
        <input
          type="text"
          id="editKeywords"
          class="w-full border border-gray-300 rounded p-2"
        />
      </div>

      <!-- OG Info -->
      <div class="border-t pt-4 mt-4">
        <h3 class="text-lg font-semibold text-[#000] mb-2">
          Open Graph (OG) Info
        </h3>

        <label class="block text-gray-700 mb-1">OG Title</label>
        <input
          type="text"
          id="editOgTitle"
          class="w-full border border-gray-300 rounded p-2"
        />

        <label class="block text-gray-700 mb-1 mt-2">OG Description</label>
        <textarea
          id="editOgDescription"
          rows="2"
          class="w-full border border-gray-300 rounded p-2"
        ></textarea>

        <label class="block text-gray-700 mb-1 mt-2">OG Image</label>
        <input
          type="file"
          id="editOgImage"
          class="w-full border border-gray-300 rounded p-2 cursor-pointer"
        />

        <label class="block text-gray-700 mb-1 mt-2">OG URL</label>
        <input
          type="text"
          id="editOgUrl"
          class="w-full border border-gray-300 rounded p-2"
        />

        <label class="block text-gray-700 mb-1 mt-2">OG Type</label>
        <input
          type="text"
          id="editOgType"
          class="w-full border border-gray-300 rounded p-2"
        />
      </div>

      <!-- Status -->
      <div class="border-t pt-4 mt-4">
        <label class="block text-gray-700 mb-1">Status</label>
        <select
          id="editStatus"
          class="w-full border border-gray-300 rounded p-2"
        >
          <option value="true">Active</option>
          <option value="false">Inactive</option>
        </select>
      </div>

      <!-- Submit -->
      <button
        type="submit"
        class="bg-[#000] text-white px-4 py-2 rounded hover:bg-gray-800 transition mt-4"
      >
        Save Changes
      </button>
    </form>
  </div>
</div>

<script>
  // ===== Modal Controls =====
  const addIdeaModal = document.getElementById("addIdeaModal");
  const openAddModalBtn = document.getElementById("openAddModalBtn");
  const closeAddModalBtn = document.getElementById("closeAddModalBtn");
  const editServiceModal = document.getElementById("editServiceModal");
  const closeEditModalBtn = document.getElementById("closeEditModalBtn");
  const editButtons = document.querySelectorAll(".openEditModalBtn");

  // Open Add Modal
  if (openAddModalBtn) {
    openAddModalBtn.addEventListener("click", () => {
      addIdeaModal.classList.remove("hidden");
    });
  }

  // Close Add Modal
  if (closeAddModalBtn) {
    closeAddModalBtn.addEventListener("click", () => {
      addIdeaModal.classList.add("hidden");
    });
  }

  // Open Edit Modal
  editButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      editServiceModal.classList.remove("hidden");
    });
  });

  // Close Edit Modal
  if (closeEditModalBtn) {
    closeEditModalBtn.addEventListener("click", () => {
      editServiceModal.classList.add("hidden");
    });
  }

  // Close modals by clicking outside
  window.addEventListener("click", (e) => {
    if (e.target === addIdeaModal) addIdeaModal.classList.add("hidden");
    if (e.target === editServiceModal) editServiceModal.classList.add("hidden");
  });

  // ===== Dynamic Detail Section =====
  const addDetailBtn = document.getElementById("addDetailSectionBtn");
  const detailsContainer = document.getElementById("detailsContainer");
  let detailCount = 1;

  if (addDetailBtn) {
    addDetailBtn.addEventListener("click", () => {
      detailCount++;
      const newSection = document.createElement("div");
      newSection.classList.add(
        "detail-section",
        "border",
        "border-gray-300",
        "rounded",
        "p-4",
        "mt-4"
      );

      newSection.innerHTML = `
        <div class="flex justify-between items-center mb-2">
          <h3 class="text-[#000] font-semibold">Detail Section ${detailCount}</h3>
          <button type="button" class="remove-section text-red-600 hover:text-red-800 text-sm">Remove</button>
        </div>
        <div>
          <label class="block text-gray-700 font-medium mb-1">Detail Title</label>
          <input type="text" name="detailTitle[]" class="w-full border border-gray-300 rounded p-2" required />
        </div>
        <div>
          <label class="block text-gray-700 font-medium mb-1">Detail Description</label>
          <textarea name="detailDescription[]" class="w-full border border-gray-300 rounded p-2" rows="3"></textarea>
        </div>
        <div>
          <label class="block text-gray-700 font-medium mb-1">Detail Image</label>
          <input type="file" name="detailImage[]" class="w-full border border-gray-300 rounded p-2 cursor-pointer" />
        </div>
        <div>
          <label class="block text-gray-700 font-medium mb-1">Detail Date</label>
          <input type="date" name="detailDate[]" class="w-full border border-gray-300 rounded p-2" />
        </div>
      `;

      detailsContainer.appendChild(newSection);
    });
  }

  // Remove detail section dynamically
  if (detailsContainer) {
    detailsContainer.addEventListener("click", (e) => {
      if (e.target.classList.contains("remove-section")) {
        e.target.closest(".detail-section").remove();
      }
    });
  }
</script>

<script>
  const addIdeaForm = document.getElementById("addIdeaForm");

  addIdeaForm.addEventListener("submit", async (e) => {
    e.preventDefault(); // prevent default form submit

    try {
      const formData = new FormData();

      // Add basic fields
      formData.append("title", addIdeaForm.title.value);
      formData.append("subTitle", addIdeaForm.subTitle.value);
      formData.append("meta_title", addIdeaForm.meta_title.value);
      formData.append("meta_description", addIdeaForm.meta_description.value);
      formData.append("keywords", addIdeaForm.keywords.value);
      formData.append("og_title", addIdeaForm.og_title.value);
      formData.append("og_description", addIdeaForm.og_description.value);
      formData.append("og_url", addIdeaForm.og_url.value);
      formData.append("og_type", addIdeaForm.og_type.value);

      // Add OG image
      if (addIdeaForm.og_image.files[0]) {
        formData.append("og_image", addIdeaForm.og_image.files[0]);
      }

      // Add multiple detail sections
      const detailSections = document.querySelectorAll(".detail-section");
      detailSections.forEach((section, index) => {
        const title = section.querySelector(
          'input[name="detailTitle[]"]'
        ).value;
        const description = section.querySelector(
          'textarea[name="detailDescription[]"]'
        ).value;
        const date = section.querySelector('input[name="detailDate[]"]').value;
        const imageInput = section.querySelector('input[name="detailImage[]"]');

        formData.append(`detail[${index}].title`, title);
        formData.append(`detail[${index}].description`, description);
        formData.append(`detail[${index}].date`, date);

        if (imageInput.files[0]) {
          formData.append(`detail[${index}].image`, imageInput.files[0]);
        }
      });

      // Send POST request
      const response = await fetch("/api/ideas", {
        method: "POST",
        body: formData,
      });

      console.log(formData);

      const result = await response.json();

      if (result.status) {
        alert("Idea added successfully!");
        addIdeaForm.reset();
        addIdeaModal.classList.add("hidden");
        window.location.reload();
      } else {
        alert("Error: " + result.message);
      }
    } catch (err) {
      console.error("Add Idea Error:", err);
      alert("Something went wrong. Check console for details.");
    }
  });

  // delete ki api
  document.querySelectorAll(".deleteBtn").forEach((btn) => {
    btn.addEventListener("click", async () => {
      const id = btn.getAttribute("data-id");

      if (!confirm("Are you sure you want to delete this achievement?")) return;

      try {
        const res = await fetch(`/api/ideas/${id}`, {
          method: "DELETE",
        });

        const data = await res.json();

        if (data.status) {
          alert("✅ partner deleted successfully!");
          btn.closest("tr").remove(); // Table row remove
        } else {
          alert("❌ Delete failed: " + data.message);
        }
      } catch (err) {
        console.error(err);
        alert("⚠️ Something went wrong!");
      }
    });
  });
</script>

<script>
  const editModal = document.getElementById("editIdeaModal");
  const editIdeaForm = document.getElementById("editIdeaForm");
  const addMoreDetailBtn = document.getElementById("addMoreDetailBtn");
  const editDetailContainer = document.getElementById("editDetailContainer");

  let currentEditId = null;

  // ✅ Open Edit Modal and Fetch Data
  document.querySelectorAll(".openEditModalBtn").forEach((btn) => {
    btn.addEventListener("click", async () => {
      currentEditId = btn.getAttribute("data-id");

      try {
        const res = await fetch(`/api/ideas/${currentEditId}`);
        const data = await res.json();

        if (data.status && data.data) {
          const idea = data.data;

          // Fill Basic Info
          document.getElementById("editTitle").value = idea.title || "";
          document.getElementById("editSubTitle").value = idea.subTitle || "";

          // Clear old details
          editDetailContainer.querySelectorAll(".detail-item").forEach((el) => el.remove());

          // Fill details dynamically
          idea.detail.forEach((d) => {
            const div = document.createElement("div");
            div.classList.add("detail-item", "border", "p-3", "rounded", "mb-3");
            div.innerHTML = `
              <label class="block text-gray-700 mb-1">Detail Title</label>
              <input type="text" name="detail_title[]" value="${d.title || ""}" class="w-full border border-gray-300 rounded p-2" required />

              <label class="block text-gray-700 mb-1 mt-2">Description</label>
              <textarea name="detail_description[]" rows="2" class="w-full border border-gray-300 rounded p-2">${d.description || ""}</textarea>

              <label class="block text-gray-700 mb-1 mt-2">Image</label>
              <input type="file" name="detail_image[]" class="w-full border border-gray-300 rounded p-2 cursor-pointer" />
              ${d.image ? `<img src="${d.image}" alt="detail image" class="w-20 mt-2 rounded" />` : ""}

              <label class="block text-gray-700 mb-1 mt-2">Date</label>
              <input type="date" name="detail_date[]" value="${d.date ? d.date.split('T')[0] : ""}" class="w-full border border-gray-300 rounded p-2" />
            `;
            editDetailContainer.appendChild(div);
          });

          // SEO
          document.getElementById("editMetaTitle").value = idea.metaTitle || "";
          document.getElementById("editMetaDescription").value = idea.metaDescription || "";
          document.getElementById("editKeywords").value = idea.keywords || "";

          // OG Info
          document.getElementById("editOgTitle").value = idea.ogTitle || "";
          document.getElementById("editOgDescription").value = idea.ogDescription || "";
          document.getElementById("editOgUrl").value = idea.ogUrl || "";
          document.getElementById("editOgType").value = idea.ogType || "";

          document.getElementById("editStatus").value = idea.status ? "true" : "false";

          // Open Modal
          editModal.classList.remove("hidden");
        } else {
          alert("Failed to fetch idea details");
        }
      } catch (err) {
        console.error(err);
        alert("Error loading idea data");
      }
    });
  });

  // ✅ Add Another Detail Section
  addMoreDetailBtn.addEventListener("click", () => {
    const div = document.createElement("div");
    div.classList.add("detail-item", "border", "p-3", "rounded", "mb-3");
    div.innerHTML = `
      <label class="block text-gray-700 mb-1">Detail Title</label>
      <input type="text" name="detail_title[]" class="w-full border border-gray-300 rounded p-2" required />

      <label class="block text-gray-700 mb-1 mt-2">Description</label>
      <textarea name="detail_description[]" rows="2" class="w-full border border-gray-300 rounded p-2"></textarea>

      <label class="block text-gray-700 mb-1 mt-2">Image</label>
      <input type="file" name="detail_image[]" class="w-full border border-gray-300 rounded p-2 cursor-pointer" />

      <label class="block text-gray-700 mb-1 mt-2">Date</label>
      <input type="date" name="detail_date[]" class="w-full border border-gray-300 rounded p-2" />
    `;
    editDetailContainer.appendChild(div);
  });

  // ✅ Close Modal
  closeEditModalBtn.addEventListener("click", () => {
    editModal.classList.add("hidden");
  });

  // ✅ Submit Updated Data
  editIdeaForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData(editIdeaForm);

    try {
      const res = await fetch(`/api/ideas/${currentEditId}`, {
        method: "PUT",
        body: formData,
      });
      const data = await res.json();

      if (data.status) {
        alert("Idea updated successfully!");
        editModal.classList.add("hidden");
        window.location.reload();
      } else {
        alert(data.message || "Failed to update idea");
      }
    } catch (err) {
      console.error(err);
      alert("Error updating idea");
    }
  });
</script>
